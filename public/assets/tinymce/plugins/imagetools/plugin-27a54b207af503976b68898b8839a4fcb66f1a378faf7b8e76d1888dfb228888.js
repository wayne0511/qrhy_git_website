!function(){"use strict";function n(t,e){return r(document.createElement("canvas"),t,e)}function o(t){return t.getContext("2d")}function r(t,e,n){return t.width=e,t.height=n,t}function i(){return new(W.getOrDie("FileReader"))}function a(u){return new A(function(t,e){function n(){a(),t(i)}function o(){a(),e("Unable to load data of type "+u.type+": "+r)}var r=URL.createObjectURL(u),i=new Image,a=function(){i.removeEventListener("load",n),i.removeEventListener("error",o)};i.addEventListener("load",n),i.addEventListener("error",o),i.src=r,i.complete&&n()})}function u(o){return new A(function(t,n){var e=new XMLHttpRequest;e.open("GET",o,!0),e.responseType="blob",e.onload=function(){200==this.status&&t(this.response)},e.onerror=function(){var t,e=this;n(0===this.status?((t=new Error("No access to download image")).code=18,t.name="SecurityError",t):new Error("Error "+e.status+" downloading image"))},e.send()})}function c(t){var e=t.split(","),n=/data:([^;]+)/.exec(e[0]);if(!n)return H.none();for(var o,r,i,a=n[1],u=e[1],c=q.atob(u),l=c.length,s=Math.ceil(l/1024),f=new Array(s),d=0;d<s;++d){for(var h=1024*d,p=Math.min(h+1024,l),m=new Array(p-h),g=h,v=0;g<p;++v,++g)m[v]=c[g].charCodeAt(0);f[d]=(o=m,new(W.getOrDie("Uint8Array"))(o))}return H.some((r=f,i={type:a},new(W.getOrDie("Blob"))(r,i)))}function l(n){return new A(function(t,e){c(n).fold(function(){e("uri is not base64: "+n)},t)})}function s(n){return new A(function(t){var e=new i;e.onloadend=function(){t(e.result)},e.readAsDataURL(n)})}function f(t,e,n){function o(e,n){return t.then(function(t){return V.canvasToDataURL(t,e,n)})}var r=e.type;return{getType:E.constant(r),toBlob:function(){return A.resolve(e)},toDataURL:function(){return n},toBase64:function(){return n.split(",")[1]},toAdjustedBlob:function(e,n){return t.then(function(t){return V.canvasToBlob(t,e,n)})},toAdjustedDataURL:o,toAdjustedBase64:function(t,e){return o(t,e).then(function(t){return t.split(",")[1]})},toCanvas:function(){return t.then(U.clone)}}}function d(e){return V.blobToDataUri(e).then(function(t){return f(V.blobToCanvas(e),e,t)})}function h(t,e,n){return(t=parseFloat(t))>n?t=n:t<e&&(t=e),t}function p(t,e){var n,o,r,i,a=[],u=new Array(10);for(n=0;n<5;n++){for(o=0;o<5;o++)a[o]=e[o+5*n];for(o=0;o<5;o++){for(r=i=0;r<5;r++)i+=t[o+5*r]*a[r];u[o+5*n]=i}}return u}function m(t,n){return n=h(n,0,1),t.map(function(t,e){return e%6==0?t=1-(1-t)*n:t*=n,h(t,0,1)})}function g(a,u){return a.toCanvas().then(function(t){return e=t,n=a.getType(),o=u,r=function(t,e){var n,o,r,i,a,u=t.data,c=e[0],l=e[1],s=e[2],f=e[3],d=e[4],h=e[5],p=e[6],m=e[7],g=e[8],v=e[9],y=e[10],b=e[11],w=e[12],x=e[13],R=e[14],I=e[15],T=e[16],k=e[17],C=e[18],B=e[19];for(a=0;a<u.length;a+=4)n=u[a],o=u[a+1],r=u[a+2],i=u[a+3],u[a]=n*c+o*l+r*s+i*f+d,u[a+1]=n*h+o*p+r*m+i*g+v,u[a+2]=n*y+o*b+r*w+i*x+R,u[a+3]=n*I+o*T+r*k+i*C+B;return t}((i=U.get2dContext(e)).getImageData(0,0,e.width,e.height),o),i.putImageData(r,0,0),X.fromCanvas(e,n);var e,n,o,r,i})}function v(a,u){return a.toCanvas().then(function(t){return e=t,n=a.getType(),o=u,r=function(t,e,n){function o(t,e,n){return n<t?t=n:t<e&&(t=e),t}var r,i,a,u,c,l,s,f,d,h,p,m,g,v,y,b;for(a=Math.round(Math.sqrt(n.length)),u=Math.floor(a/2),r=t.data,i=e.data,y=t.width,b=t.height,l=0;l<b;l++)for(c=0;c<y;c++){for(s=f=d=0,p=0;p<a;p++)for(h=0;h<a;h++)m=o(c+h-u,0,y-1),g=4*(o(l+p-u,0,b-1)*y+m),v=n[p*a+h],s+=r[g]*v,f+=r[g+1]*v,d+=r[g+2]*v;i[g=4*(l*y+c)]=o(s,0,255),i[g+1]=o(f,0,255),i[g+2]=o(d,0,255)}return e}((i=U.get2dContext(e)).getImageData(0,0,e.width,e.height),r=i.getImageData(0,0,e.width,e.height),o),i.putImageData(r,0,0),X.fromCanvas(e,n);var e,n,o,r,i})}function t(u){return function(e,n){return e.toCanvas().then(function(t){return function(t,e,n){var o,r,i=U.get2dContext(t),a=new Array(256);for(r=0;r<a.length;r++)a[r]=u(r,n);return o=function(t,e){var n,o=t.data;for(n=0;n<o.length;n+=4)o[n]=e[o[n]],o[n+1]=e[o[n+1]],o[n+2]=e[o[n+2]];return t}(i.getImageData(0,0,t.width,t.height),a),i.putImageData(o,0,0),X.fromCanvas(t,e)}(t,e.getType(),n)})}}function y(n){return function(t,e){return g(t,n(Q.identity(),e))}}function b(e){return function(t){return v(t,e)}}function Y(t){return{blob:t,url:ut.createObjectURL(t)}}function J(t){t&&ut.revokeObjectURL(t.url)}function K(t){Z.each(t,J)}function w(i,a,t,e){function n(t){var e,n,o,r;e=y.find("#w")[0],n=y.find("#h")[0],o=parseInt(e.value(),10),r=parseInt(n.value(),10),y.find("#constrain")[0].checked()&&P&&W&&o&&r&&("w"===t.control.settings.name?(r=Math.round(o*q),n.value(r)):(o=Math.round(r*V),e.value(o))),P=o,W=r}function u(t){return Math.round(100*t)+"%"}function o(){y.find("#undo").disabled(!N.canUndo()),y.find("#redo").disabled(!N.canRedo()),y.statusbar.find("#save").disabled(!N.canUndo())}function c(){y.find("#undo").disabled(!0),y.find("#redo").disabled(!0)}function l(t){t&&k.imageSrc(t.url)}function r(e){return function(){var t=Z.grep(F,function(t){return t.settings.name!==e});Z.each(t,function(t){t.hide()}),e.show(),e.focus()}}function s(t){l(x=Y(t))}function f(t){l(a=Y(t)),K(N.add(a).removed),o()}function d(){var e=k.selection();it.blobToImageResult(a.blob).then(function(t){ot.crop(t,e.x,e.y,e.w,e.h).then(G).then(function(t){f(t),h()})})}function h(){l(a),J(x),r(b)(),o()}function p(){x?(f(x.blob),h()):function t(e,n){x?n():setTimeout(function(){0<e--?t(e,n):i.windowManager.alert("Error: failed to apply image operation.")},10)}(100,p)}function m(t){return pt.create("Form",{layout:"flex",direction:"row",labelGap:5,border:"0 0 1 0",align:"center",pack:"center",padding:"0 10 0 10",spacing:5,flex:0,minHeight:60,defaults:{classes:"imagetool",type:"button"},items:t})}function g(t,e){return m($([{text:"Back",onclick:h},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:p}])).hide().on("show",function(){c(),it.blobToImageResult(a.blob).then(function(t){return e(t)}).then(G).then(function(t){var e=Y(t);l(e),J(x),x=e})})}function v(t,n,e,o,r){return m($([{text:"Back",onclick:h},{type:"spacer",flex:1},{type:"slider",flex:1,ondragend:function(t){var e;e=t.value,it.blobToImageResult(a.blob).then(function(t){return n(t,e)}).then(G).then(function(t){var e=Y(t);l(e),J(x),x=e})},minValue:i.rtl?r:o,maxValue:i.rtl?o:r,value:e,previewFilter:u},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:p}])).hide().on("show",function(){this.find("slider").value(e),c()})}var y,b,w,x,R,I,T,k,C,B,U,M,A,j,E,z,O,D,S,L,H,_,F,P,W,q,V,N=function(){function t(){return 0<o}function e(){return-1!==o&&o<n.length-1}var n=[],o=-1;return{data:n,add:function(t){var e;return e=n.splice(++o),n.push(t),{state:t,removed:e}},undo:function(){if(t())return n[--o]},redo:function(){if(e())return n[++o]},canUndo:t,canRedo:e}}(),$=function(t){return i.rtl?t.reverse():t},X=function(e){var n=[].slice.call(arguments,1);return function(){var t=x||a;it.blobToImageResult(t.blob).then(function(t){e.apply(this,[t].concat(n)).then(G).then(s)})}},G=function(t){return t.toBlob()};R=m($([{text:"Back",onclick:h},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:d}])).hide().on("show hide",function(t){k.toggleCropRect("show"===t.type)}).on("show",c),I=m($([{text:"Back",onclick:h},{type:"spacer",flex:1},{type:"textbox",name:"w",label:"Width",size:4,onkeyup:n},{type:"textbox",name:"h",label:"Height",size:4,onkeyup:n},{type:"checkbox",name:"constrain",text:"Constrain proportions",checked:!0,onchange:function(t){!0===t.control.value()&&(q=W/P,V=P/W)}},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:"submit"}])).hide().on("submit",function(t){var e=parseInt(y.find("#w").value(),10),n=parseInt(y.find("#h").value(),10);t.preventDefault(),function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var o=[].slice.call(arguments,1);return function(){it.blobToImageResult(a.blob).then(function(t){e.apply(this,[t].concat(o)).then(G).then(f)})}}(ot.resize,e,n)(),h()}).on("show",c),T=m($([{text:"Back",onclick:h},{type:"spacer",flex:1},{icon:"fliph",tooltip:"Flip horizontally",onclick:X(ot.flip,"h")},{icon:"flipv",tooltip:"Flip vertically",onclick:X(ot.flip,"v")},{icon:"rotateleft",tooltip:"Rotate counterclockwise",onclick:X(ot.rotate,-90)},{icon:"rotateright",tooltip:"Rotate clockwise",onclick:X(ot.rotate,90)},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:p}])).hide().on("show",c),U=g(0,ot.invert),S=g(0,ot.sharpen),L=g(0,ot.emboss),M=v(0,ot.brightness,0,-1,1),A=v(0,ot.hue,180,0,360),j=v(0,ot.saturate,0,-1,1),E=v(0,ot.contrast,0,-1,1),z=v(0,ot.grayscale,0,0,1),O=v(0,ot.sepia,0,0,1),D=function(t,r){function e(){var e,n,o;e=y.find("#r")[0].value(),n=y.find("#g")[0].value(),o=y.find("#b")[0].value(),it.blobToImageResult(a.blob).then(function(t){return r(t,e,n,o)}).then(G).then(function(t){var e=Y(t);l(e),J(x),x=e})}var n=i.rtl?2:0,o=i.rtl?0:2;return m($([{text:"Back",onclick:h},{type:"spacer",flex:1},{type:"slider",label:"R",name:"r",minValue:n,value:1,maxValue:o,ondragend:e,previewFilter:u},{type:"slider",label:"G",name:"g",minValue:n,value:1,maxValue:o,ondragend:e,previewFilter:u},{type:"slider",label:"B",name:"b",minValue:n,value:1,maxValue:o,ondragend:e,previewFilter:u},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:p}])).hide().on("show",function(){y.find("#r,#g,#b").value(1),c()})}(0,ot.colorize),H=v(0,ot.gamma,0,-1,1),_=v(0,ot.exposure,1,0,2),w=m($([{text:"Back",onclick:h},{type:"spacer",flex:1},{text:"hue",icon:"hue",onclick:r(A)},{text:"saturate",icon:"saturate",onclick:r(j)},{text:"sepia",icon:"sepia",onclick:r(O)},{text:"emboss",icon:"emboss",onclick:r(L)},{text:"exposure",icon:"exposure",onclick:r(_)},{type:"spacer",flex:1}])).hide(),b=m($([{tooltip:"Crop",icon:"crop",onclick:r(R)},{tooltip:"Resize",icon:"resize2",onclick:r(I)},{tooltip:"Orientation",icon:"orientation",onclick:r(T)},{tooltip:"Brightness",icon:"sun",onclick:r(M)},{tooltip:"Sharpen",icon:"sharpen",onclick:r(S)},{tooltip:"Contrast",icon:"contrast",onclick:r(E)},{tooltip:"Color levels",icon:"drop",onclick:r(D)},{tooltip:"Gamma",icon:"gamma",onclick:r(H)},{tooltip:"Invert",icon:"invert",onclick:r(U)}])),k=xt.create({flex:1,imageSrc:a.url}),C=pt.create("Container",{layout:"flex",direction:"column",pack:"start",border:"0 1 0 0",padding:5,spacing:5,items:[{type:"button",icon:"undo",tooltip:"Undo",name:"undo",onclick:function(){l(a=N.undo()),o()}},{type:"button",icon:"redo",tooltip:"Redo",name:"redo",onclick:function(){l(a=N.redo()),o()}},{type:"button",icon:"zoomin",tooltip:"Zoom in",onclick:function(){var t=k.zoom();t<2&&(t+=.1),k.zoom(t)}},{type:"button",icon:"zoomout",tooltip:"Zoom out",onclick:function(){var t=k.zoom();.1<t&&(t-=.1),k.zoom(t)}}]}),B=pt.create("Container",{type:"container",layout:"flex",direction:"row",align:"stretch",flex:1,items:$([C,k])}),F=[b,R,I,T,w,U,M,A,j,E,z,O,D,S,L,H,_],(y=i.windowManager.open({layout:"flex",direction:"column",align:"stretch",minWidth:Math.min(ht.DOM.getViewPort().w,800),minHeight:Math.min(ht.DOM.getViewPort().h,650),title:"Edit image",items:F.concat([B]),buttons:$([{text:"Save",name:"save",subtype:"primary",onclick:function(){t(a.blob),y.close()}},{text:"Cancel",onclick:"close"}])})).on("close",function(){e(),K(N.data),x=N=null}),N.add(a),o(),k.on("load",function(){P=k.imageSize().w,W=k.imageSize().h,q=W/P,V=P/W,y.find("#w").value(P),y.find("#h").value(W)}),k.on("crop",d)}var x,R,I,T,k,C=function(t){var e=t,n=function(){return e};return{get:n,set:function(t){e=t},clone:function(){return C(n())}}},B=tinymce.util.Tools.resolve("tinymce.PluginManager"),Z=tinymce.util.Tools.resolve("tinymce.util.Tools"),U={create:n,clone:function(t){var e;return o(e=n(t.width,t.height)).drawImage(t,0,0),e},resize:r,get2dContext:o,get3dContext:function(t){var e=null;try{e=t.getContext("webgl")||t.getContext("experimental-webgl")}catch(Z){}return e||(e=null),e}},M={getWidth:function(t){return t.naturalWidth||t.width},getHeight:function(t){return t.naturalHeight||t.height}},A=window.Promise?window.Promise:function(){function n(t,e){return function(){t.apply(e,arguments)}}function i(n){var o=this;null!==this._state?t(function(){var t=o._state?n.onFulfilled:n.onRejected;if(null!==t){var e;try{e=t(o._value)}catch(i){return void n.reject(i)}n.resolve(e)}else(o._state?n.resolve:n.reject)(o._value)}):this._deferreds.push(n)}function o(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var e=t.then;if("function"==typeof e)return void c(n(e,t),n(o,this),n(r,this))}this._state=!0,this._value=t,a.call(this)}catch(s){r.call(this,s)}}function r(t){this._state=!1,this._value=t,a.call(this)}function a(){for(var t=0,e=this._deferreds.length;t<e;t++)i.call(this,this._deferreds[t]);this._deferreds=null}function c(t,e,n){var o=!1;try{t(function(t){o||(o=!0,e(t))},function(t){o||(o=!0,n(t))})}catch(i){if(o)return;o=!0,n(i)}}var l=function(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],c(t,n(o,this),n(r,this))},t=l.immediateFn||"function"==typeof setImmediate&&setImmediate||function(t){setTimeout(t,1)},s=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};return l.prototype["catch"]=function(t){return this.then(null,t)},l.prototype.then=function(n,o){var r=this;return new l(function(t,e){i.call(r,new function(t,e,n,o){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.resolve=n,this.reject=o}(n,o,t,e))})},l.all=function(t){var u=Array.prototype.slice.call(1===arguments.length&&s(t)?t:arguments);return new l(function(o,r){function i(e,t){try{if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if("function"==typeof n)return void n.call(t,function(t){i(e,t)},r)}u[e]=t,0==--a&&o(u)}catch(c){r(c)}}if(0===u.length)return o([]);for(var a=u.length,t=0;t<u.length;t++)i(t,u[t])})},l.resolve=function(e){return e&&"object"==typeof e&&e.constructor===l?e:new l(function(t){t(e)})},l.reject=function(n){return new l(function(t,e){e(n)})},l.race=function(r){return new l(function(t,e){for(var n=0,o=r.length;n<o;n++)r[n].then(t,e)})},l}(),j=function(t){return function(){return t}},E={noop:function(){},noarg:function(t){return function(){return t()}},compose:function(t,e){return function(){return t(e.apply(null,arguments))}},constant:j,identity:function(t){return t},tripleEquals:function(t,e){return t===e},curry:function(o){for(var r=new Array(arguments.length-1),t=1;t<arguments.length;t++)r[t-1]=arguments[t];return function(){for(var t=new Array(arguments.length),e=0;e<t.length;e++)t[e]=arguments[e];var n=r.concat(t);return o.apply(null,n)}},not:function(t){return function(){return!t.apply(null,arguments)}},die:function(t){return function(){throw new Error(t)}},apply:function(t){return t()},call:function(t){t()},never:j(!1),always:j(!0)},z=E.never,O=E.always,D=function(){return S},S=(T={fold:function(t){return t()},is:z,isSome:z,isNone:O,getOr:I=function(t){return t},getOrThunk:R=function(t){return t()},getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},or:I,orThunk:R,map:D,ap:D,each:function(){},bind:D,flatten:D,exists:z,forall:O,filter:D,equals:x=function(t){return t.isNone()},equals_:x,toArray:function(){return[]},toString:E.constant("none()")},Object.freeze&&Object.freeze(T),T),L=function(n){var t=function(){return n},e=function(){return r},o=function(t){return t(n)},r={fold:function(t,e){return e(n)},is:function(t){return n===t},isSome:O,isNone:z,getOr:t,getOrThunk:t,getOrDie:t,or:e,orThunk:e,map:function(t){return L(t(n))},ap:function(t){return t.fold(D,function(t){return L(t(n))})},each:function(t){t(n)},bind:o,flatten:t,exists:o,forall:o,filter:function(t){return t(n)?r:S},equals:function(t){return t.is(n)},equals_:function(t,e){return t.fold(z,function(t){return e(n,t)})},toArray:function(){return[n]},toString:function(){return"some("+n+")"}};return r},H={some:L,none:D,from:function(t){return null===t||t===undefined?S:L(t)}},_="undefined"!=typeof window?window:Function("return this;")(),F=function(t,e){for(var n=e!==undefined&&null!==e?e:_,o=0;o<t.length&&n!==undefined&&null!==n;++o)n=n[t[o]];return n},P=function(t,e){var n=t.split(".");return F(n,e)},W={getOrDie:function(t,e){var n=P(t,e);if(n===undefined||null===n)throw t+" not available on this browser";return n}},q={atob:function(t){return W.getOrDie("atob")(t)},requestAnimationFrame:function(t){W.getOrDie("requestAnimationFrame")(t)}},V={blobToImage:a,imageToBlob:function(t){return(n=t,new A(function(e){n.complete?e(n):n.addEventListener("load",function t(){n.removeEventListener("load",t),e(n)})})).then(function(t){var e=t.src;return 0===e.indexOf("blob:")?u(e):0===e.indexOf("data:")?l(e):u(e)});var n},blobToArrayBuffer:function(n){return new A(function(t){var e=new i;e.onloadend=function(){t(e.result)},e.readAsArrayBuffer(n)})},blobToDataUri:s,blobToBase64:function(t){return s(t).then(function(t){return t.split(",")[1]})},dataUriToBlobSync:c,canvasToBlob:function(t,n,o){return n=n||"image/png",HTMLCanvasElement.prototype.toBlob?new A(function(e){t.toBlob(function(t){e(t)},n,o)}):l(t.toDataURL(n,o))},canvasToDataURL:function(t,e,n){return e=e||"image/png",t.then(function(t){return t.toDataURL(e,n)})},blobToCanvas:function(t){return a(t).then(function(t){var e,n;return e=t,URL.revokeObjectURL(e.src),n=U.create(M.getWidth(t),M.getHeight(t)),U.get2dContext(n).drawImage(t,0,0),n})},uriToBlob:function(t){return 0===t.indexOf("blob:")?u(t):0===t.indexOf("data:")?l(t):null}},N=function(t){return V.blobToImage(t)},$=function(t){return V.imageToBlob(t)},X={fromBlob:d,fromCanvas:function(e,t){return V.canvasToBlob(e,t).then(function(t){return f(A.resolve(e),t,e.toDataURL())})},fromImage:function(t){return V.imageToBlob(t).then(function(t){return d(t)})},fromBlobAndUrlSync:function(t,e){return f(V.blobToCanvas(t),t,e)}},G=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10],Q={identity:function(){return[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1]},adjust:m,multiply:p,adjustContrast:function(t,e){var n;return e=h(e,-1,1),p(t,[(n=(e*=100)<0?127+e/100*127:127*(n=0==(n=e%1)?G[e]:G[Math.floor(e)]*(1-n)+G[Math.floor(e)+1]*n)+127)/127,0,0,0,.5*(127-n),0,n/127,0,0,.5*(127-n),0,0,n/127,0,.5*(127-n),0,0,0,1,0,0,0,0,0,1])},adjustBrightness:function(t,e){return p(t,[1,0,0,0,e=h(255*e,-255,255),0,1,0,0,e,0,0,1,0,e,0,0,0,1,0,0,0,0,0,1])},adjustSaturation:function(t,e){var n;return p(t,[.3086*(1-(n=1+(0<(e=h(e,-1,1))?3*e:e)))+n,.6094*(1-n),.082*(1-n),0,0,.3086*(1-n),.6094*(1-n)+n,.082*(1-n),0,0,.3086*(1-n),.6094*(1-n),.082*(1-n)+n,0,0,0,0,0,1,0,0,0,0,0,1])},adjustHue:function(t,e){var n,o,r,i,a;return e=h(e,-180,180)/180*Math.PI,p(t,[(r=.213)+.787*(n=Math.cos(e))+(o=Math.sin(e))*-r,(i=.715)+n*-i+o*-i,(a=.072)+n*-a+.928*o,0,0,r+n*-r+.143*o,i+n*(1-i)+.14*o,a+n*-a+-.283*o,0,0,r+n*-r+-.787*o,i+n*-i+o*i,a+.928*n+o*a,0,0,0,0,0,1,0,0,0,0,0,1])},adjustColors:function(t,e,n,o){return p(t,[e=h(e,0,2),0,0,0,0,0,n=h(n,0,2),0,0,0,0,0,o=h(o,0,2),0,0,0,0,0,1,0,0,0,0,0,1])},adjustSepia:function(t,e){return p(t,m([.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0,0,0,0,0,1],e=h(e,0,1)))},adjustGrayscale:function(t,e){return p(t,m([.33,.34,.33,0,0,.33,.34,.33,0,0,.33,.34,.33,0,0,0,0,0,1,0,0,0,0,0,1],e=h(e,0,1)))}},tt={invert:(k=[-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0],function(t){return g(t,k)}),brightness:y(Q.adjustBrightness),hue:y(Q.adjustHue),saturate:y(Q.adjustSaturation),contrast:y(Q.adjustContrast),grayscale:y(Q.adjustGrayscale),sepia:y(Q.adjustSepia),colorize:function(t,e,n,o){return g(t,Q.adjustColors(Q.identity(),e,n,o))},sharpen:b([0,-1,0,-1,5,-1,0,-1,0]),emboss:b([-2,-1,0,-1,1,1,0,1,2]),gamma:t(function(t,e){return 255*Math.pow(t/255,1-e)}),exposure:t(function(t,e){return 255*(1-Math.exp(-t/255*e))}),colorFilter:g,convoluteFilter:v},et={scale:function e(t,n,o){var r=M.getWidth(t),i=M.getHeight(t),a=n/r,u=o/i,c=!1;(a<.5||2<a)&&(a=a<.5?.5:2,c=!0),(u<.5||2<u)&&(u=u<.5?.5:2,c=!0);var l,s,f,d=(l=t,s=a,f=u,new A(function(t){var e=M.getWidth(l),n=M.getHeight(l),o=Math.floor(e*s),r=Math.floor(n*f),i=U.create(o,r);U.get2dContext(i).drawImage(l,0,0,e,n,0,0,o,r),t(i)}));return c?d.then(function(t){return e(t,n,o)}):d}},nt={rotate:function(c,l){return c.toCanvas().then(function(t){return e=t,n=c.getType(),o=l,r=U.create(e.width,e.height),i=U.get2dContext(r),90!=(o=o<(u=a=0)?360+o:o)&&270!=o||U.resize(r,r.height,r.width),90!=o&&180!=o||(a=r.width),270!=o&&180!=o||(u=r.height),i.translate(a,u),i.rotate(o*Math.PI/180),i.drawImage(e,0,0),X.fromCanvas(r,n);var e,n,o,r,i,a,u})},flip:function(a,u){return a.toCanvas().then(function(t){return e=t,n=a.getType(),o=u,r=U.create(e.width,e.height),i=U.get2dContext(r),"v"==o?(i.scale(1,-1),i.drawImage(e,0,-r.height)):(i.scale(-1,1),i.drawImage(e,-r.width,0)),X.fromCanvas(r,n);var e,n,o,r,i})},crop:function(c,l,s,f,d){return c.toCanvas().then(function(t){return e=t,n=c.getType(),o=l,r=s,i=f,a=d,u=U.create(i,a),U.get2dContext(u).drawImage(e,-o,-r),X.fromCanvas(u,n);var e,n,o,r,i,a,u})},resize:function(e,n,o){return e.toCanvas().then(function(t){return et.scale(t,n,o).then(function(t){return X.fromCanvas(t,e.getType())})})}},ot={invert:function(t){return tt.invert(t)},sharpen:function(t){return tt.sharpen(t)},emboss:function(t){return tt.emboss(t)},brightness:function(t,e){return tt.brightness(t,e)},hue:function(t,e){return tt.hue(t,e)},saturate:function(t,e){return tt.saturate(t,e)},contrast:function(t,e){return tt.contrast(t,e)},grayscale:function(t,e){return tt.grayscale(t,e)},sepia:function(t,e){return tt.sepia(t,e)},colorize:function(t,e,n,o){return tt.colorize(t,e,n,o)},gamma:function(t,e){return tt.gamma(t,e)},exposure:function(t,e){return tt.exposure(t,e)},flip:function(t,e){return nt.flip(t,e)},crop:function(t,e,n,o,r){return nt.crop(t,e,n,o,r)},resize:function(t,e,n){return nt.resize(t,e,n)},rotate:function(t,e){return nt.rotate(t,e)}},rt=function(t){return t.toBlob()},it={blobToImageResult:function(t){return X.fromBlob(t)},fromBlobAndUrlSync:function(t,e){return X.fromBlobAndUrlSync(t,e)},imageToImageResult:function(t){return X.fromImage(t)},imageResultToBlob:function(t,e,n){return e===undefined&&n===undefined?rt(t):t.toAdjustedBlob(e,n)},imageResultToOriginalBlob:rt,imageResultToDataURL:function(t){return t.toDataURL()}},at=function(){return W.getOrDie("URL")},ut={createObjectURL:function(t){return at().createObjectURL(t)},revokeObjectURL:function(t){at().revokeObjectURL(t)}},ct=tinymce.util.Tools.resolve("tinymce.util.Delay"),lt=tinymce.util.Tools.resolve("tinymce.util.Promise"),st=tinymce.util.Tools.resolve("tinymce.util.URI"),ft=function(t){return t.getParam("imagetools_toolbar","rotateleft rotateright | flipv fliph | crop editimage imageoptions")},dt=function(t){return t.getParam("imagetools_proxy")},ht=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),pt=tinymce.util.Tools.resolve("tinymce.ui.Factory"),mt=tinymce.util.Tools.resolve("tinymce.geom.Rect"),gt=function(n){return new lt(function(t){var e=function(){n.removeEventListener("load",e),t(n)};n.complete?t(n):n.addEventListener("load",e)})},vt=tinymce.util.Tools.resolve("tinymce.dom.DomQuery"),yt=tinymce.util.Tools.resolve("tinymce.util.Observable"),bt=tinymce.util.Tools.resolve("tinymce.util.VK"),wt=0,xt={create:function(t){return new(pt.get("Control").extend({Defaults:{classes:"imagepanel"},selection:function(t){return arguments.length?(this.state.set("rect",t),this):this.state.get("rect")},imageSize:function(){var t=this.state.get("viewRect");return{w:t.w,h:t.h}},toggleCropRect:function(t){this.state.set("cropEnabled",t)},imageSrc:function(t){var r=this,i=new Image;i.src=t,gt(i).then(function(){var t,e,n=r.state.get("viewRect");if((e=r.$el.find("img"))[0])e.replaceWith(i);else{var o=document.createElement("div");o.className="mce-imagepanel-bg",r.getEl().appendChild(o),r.getEl().appendChild(i)}t={x:0,y:0,w:i.naturalWidth,h:i.naturalHeight},r.state.set("viewRect",t),r.state.set("rect",mt.inflate(t,-20,-20)),n&&n.w===t.w&&n.h===t.h||r.zoomFit(),r.repaintImage(),r.fire("load")})},zoom:function(t){return arguments.length?(this.state.set("zoom",t),this):this.state.get("zoom")},postRender:function(){return this.imageSrc(this.settings.imageSrc),this._super()},zoomFit:function(){var t,e,n,o,r,i;t=this.$el.find("img"),e=this.getEl().clientWidth,n=this.getEl().clientHeight,o=t[0].naturalWidth,r=t[0].naturalHeight,1<=(i=Math.min((e-10)/o,(n-10)/r))&&(i=1),this.zoom(i)},repaintImage:function(){var t,e,n,o,r,i,a,u,c,l,s;s=this.getEl(),c=this.zoom(),l=this.state.get("rect"),a=this.$el.find("img"),u=this.$el.find(".mce-imagepanel-bg"),r=s.offsetWidth,i=s.offsetHeight,n=a[0].naturalWidth*c,o=a[0].naturalHeight*c,t=Math.max(0,r/2-n/2),e=Math.max(0,i/2-o/2),a.css({left:t,top:e,width:n,height:o}),u.css({left:t,top:e,width:n,height:o}),this.cropRect&&(this.cropRect.setRect({x:l.x*c+t,y:l.y*c+e,w:l.w*c,h:l.h*c}),this.cropRect.setClampRect({x:t,y:e,w:n,h:o}),this.cropRect.setViewPortRect({x:0,y:0,w:r,h:i}))},bindStates:function(){function n(t){o.cropRect=function(l,n,s,o,r){function f(t,e){return{x:e.x-t.x,y:e.y-t.y,w:e.w,h:e.h}}function a(t,e,n,o){var r,i,a,u,c;r=e.x,i=e.y,a=e.w,u=e.h,r+=n*t.deltaX,i+=o*t.deltaY,(a+=n*t.deltaW)<20&&(a=20),(u+=o*t.deltaH)<20&&(u=20),c=l=mt.clamp({x:r,y:i,w:a,h:u},s,"move"===t.name),c=f(s,c),h.fire("updateRect",{rect:c}),d(c)}function e(e){function t(t,e){e.h<0&&(e.h=0),e.w<0&&(e.w=0),vt("#"+m+"-"+t,o).css({left:e.x,top:e.y,width:e.w,height:e.h})}Z.each(u,function(t){vt("#"+m+"-"+t.name,o).css({left:e.w*t.xMul+e.x,top:e.h*t.yMul+e.y})}),t("top",{x:n.x,y:n.y,w:n.w,h:e.y-n.y}),t("right",{x:e.x+e.w,y:e.y,w:n.w-e.x-e.w+n.x,h:e.h}),t("bottom",{x:n.x,y:e.y+e.h,w:n.w,h:n.h-e.y-e.h+n.y}),t("left",{x:n.x,y:e.y,w:e.x-n.x,h:e.h}),t("move",e)}function i(t){e(l=t)}function d(t){var e,n;i((e=s,{x:(n=t).x+e.x,y:n.y+e.y,w:n.w,h:n.h}))}var h,u,t,c,p="mce-",m=p+"crid-"+wt++;return u=[{name:"move",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:0,deltaH:0,label:"Crop Mask"},{name:"nw",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:-1,deltaH:-1,label:"Top Left Crop Handle"},{name:"ne",xMul:1,yMul:0,deltaX:0,deltaY:1,deltaW:1,deltaH:-1,label:"Top Right Crop Handle"},{name:"sw",xMul:0,yMul:1,deltaX:1,deltaY:0,deltaW:-1,deltaH:1,label:"Bottom Left Crop Handle"},{name:"se",xMul:1,yMul:1,deltaX:0,deltaY:0,deltaW:1,deltaH:1,label:"Bottom Right Crop Handle"}],c=["top","right","bottom","left"],vt('<div id="'+m+'" class="'+p+'croprect-container" role="grid" aria-dropeffect="execute">').appendTo(o),Z.each(c,function(t){vt("#"+m,o).append('<div id="'+m+"-"+t+'"class="'+p+'croprect-block" style="display: none" data-mce-bogus="all">')}),Z.each(u,function(t){vt("#"+m,o).append('<div id="'+m+"-"+t.name+'" class="'+p+"croprect-handle "+p+"croprect-handle-"+t.name+'"style="display: none" data-mce-bogus="all" role="gridcell" tabindex="-1" aria-label="'+t.label+'" aria-grabbed="false">')}),t=Z.map(u,function(e){var n;return new(pt.get("DragHelper"))(m,{document:o.ownerDocument,handle:m+"-"+e.name,start:function(){n=l},drag:function(t){a(e,n,t.deltaX,t.deltaY)}})}),e(l),vt(o).on("focusin focusout",function(t){vt(t.target).attr("aria-grabbed","focus"===t.type)}),vt(o).on("keydown",function(e){function t(t,e,n,o,r){t.stopPropagation(),t.preventDefault(),a(i,n,o,r)}var i;switch(Z.each(u,function(t){if(e.target.id===m+"-"+t.name)return i=t,!1}),e.keyCode){case bt.LEFT:t(e,0,l,-10,0);break;case bt.RIGHT:t(e,0,l,10,0);break;case bt.UP:t(e,0,l,0,-10);break;case bt.DOWN:t(e,0,l,0,10);break;case bt.ENTER:case bt.SPACEBAR:e.preventDefault(),r()}}),h=Z.extend({toggleVisibility:function(t){var e;e=Z.map(u,function(t){return"#"+m+"-"+t.name}).concat(Z.map(c,function(t){return"#"+m+"-"+t})).join(","),t?vt(e,o).show():vt(e,o).hide()},setClampRect:function(t){s=t,e(l)},setRect:i,getInnerRect:function(){return f(s,l)},setInnerRect:d,setViewPortRect:function(t){n=t,e(l)},destroy:function(){Z.each(t,function(t){t.destroy()}),t=[]}},yt)}(t,o.state.get("viewRect"),o.state.get("viewRect"),o.getEl(),function(){o.fire("crop")}),o.cropRect.on("updateRect",function(t){var e=t.rect,n=o.zoom();e={x:Math.round(e.x/n),y:Math.round(e.y/n),w:Math.round(e.w/n),h:Math.round(e.h/n)},o.state.set("rect",e)}),o.on("remove",o.cropRect.destroy)}var o=this;o.state.on("change:cropEnabled",function(t){o.cropRect.toggleVisibility(t.value),o.repaintImage()}),o.state.on("change:zoom",function(){o.repaintImage()}),o.state.on("change:rect",function(t){var e=t.value;o.cropRect||n(e),o.cropRect.setRect(e)})}}))(t)}},Rt={edit:function(o,t){return new lt(function(e,n){return t.toBlob().then(function(t){w(o,Y(t),e,n)})})}},It={getImageSize:function(t){function e(t){return/^[0-9\.]+px$/.test(t)}var n,o;return n=t.style.width,o=t.style.height,n||o?e(n)&&e(o)?{w:parseInt(n,10),h:parseInt(o,10)}:null:(n=t.width,o=t.height,n&&o?{w:parseInt(n,10),h:parseInt(o,10)}:null)},setImageSize:function(t,e){var n,o;e&&(n=t.style.width,o=t.style.height,(n||o)&&(t.style.width=e.w+"px",t.style.height=e.h+"px",t.removeAttribute("data-mce-style")),n=t.width,o=t.height,(n||o)&&(t.setAttribute("width",e.w),t.setAttribute("height",e.h)))},getNaturalImageSize:function(t){return{w:t.naturalWidth,h:t.naturalHeight}}},Tt=(Array.prototype.indexOf,undefined,Array.prototype.push,Array.prototype.slice,function(t,e){for(var n=0,o=t.length;n<o;n++){var r=t[n];if(e(r,n,t))return H.some(r)}return H.none()}),kt=function(t){return null!==t&&t!==undefined},Ct={traverse:function(t,e){var n;return n=e.reduce(function(t,e){return kt(t)?t[e]:undefined},t),kt(n)?n:null},readBlob:function(e){return new lt(function(n){var t=new i;t.onload=function(t){var e=t.target;n(e.result)},t.readAsText(e)})},requestUrlAsBlob:function(e,o){return new lt(function(t){var n;(n=new function(){return new(W.getOrDie("XMLHttpRequest"))}).onreadystatechange=function(){4===n.readyState&&t({status:n.status,blob:this.response})},n.open("GET",e,!0),Z.each(o,function(t,e){n.setRequestHeader(e,t)}),n.responseType="blob",n.send()})},parseJson:function(t){var e;try{e=JSON.parse(t)}catch(Z){}return e}},Bt=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],Ut=[{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],Mt=function(e){return"ImageProxy HTTP error: "+Tt(Bt,function(t){return e===t.code}).fold(E.constant("Unknown ImageProxy error"),function(t){return t.message})},At=function(t){var e=Mt(t);return lt.reject(e)},jt=function(e){return Tt(Ut,function(t){return t.type===e}).fold(E.constant("Unknown service error"),function(t){return t.message})},Et=function(t,e){return Ct.readBlob(e).then(function(t){var e,n,o,r=(e=t,n=Ct.parseJson(e),"ImageProxy Service error: "+((o=Ct.traverse(n,["error","type"]))?jt(o):"Invalid JSON in service error message"));return lt.reject(r)})},zt={handleServiceErrorResponse:function(t,e){return 400===(n=t)||403===n||500===n?Et(0,e):At(t);var n},handleHttpError:At,getHttpErrorMsg:Mt,getServiceErrorMsg:jt},Ot=function(t,e){return Ct.requestUrlAsBlob((n=t,o=e,r=-1===n.indexOf("?")?"?":"&",/[?&]apiKey=/.test(n)||!o?n:n+r+"apiKey="+encodeURIComponent(o)),{"Content-Type":"application/json;charset=UTF-8","tiny-api-key":e}).then(function(t){return t.status<200||300<=t.status?zt.handleServiceErrorResponse(t.status,t.blob):lt.resolve(t.blob)});var n,o,r},Dt=function(t,e){return e?Ot(t,e):(n=t,Ct.requestUrlAsBlob(n,{}).then(function(t){return t.status<200||300<=t.status?zt.handleHttpError(t.status):lt.resolve(t.blob)}));var n},St=0,Lt=function(t,e){t.notificationManager.open({text:e,type:"error"})},Ht=function(t){return t.selection.getNode()},_t=function(t,e){var n=e.src;return 0===n.indexOf("data:")||0===n.indexOf("blob:")||new st(n).host===t.documentBaseURI.host},Ft=function(t,e){return-1!==Z.inArray(t.settings.imagetools_cors_hosts,new st(e.src).host)},Pt=function(t){var e,n,o,r,i,a;return(e=t.editorUpload.blobCache.getByUri(Ht(t).src))?lt.resolve(e.blob()):(a=(o=Ht(n=t)).src,Ft(n,o)?Dt(o.src,null):_t(n,o)?$(o):(a=dt(n),a+=(-1===a.indexOf("?")?"?":"&")+"url="+encodeURIComponent(o.src),r=(i=n).settings.api_key||i.settings.imagetools_api_key,Dt(a,r)))},Wt=function(t,e){var n=ct.setEditorTimeout(t,function(){t.editorUpload.uploadImagesAuto()
},t.settings.images_upload_timeout||3e4);e.set(n)},qt=function(t){clearTimeout(t.get())},Vt=function(c,l,s,f,d){return l.toBlob().then(function(t){var e,n,o,r,i,a,u;return o=c.editorUpload.blobCache,e=(i=Ht(c)).src,c.settings.images_reuse_filename&&((r=o.getByUri(e))?(e=r.uri(),n=r.name()):(a=c,n=(u=e.match(/\/([^\/\?]+)?\.(?:jpeg|jpg|png|gif)(?:\?|$)/i))?a.dom.encode(u[1]):null)),r=o.create({id:"imagetools"+St++,blob:t,base64:l.toBase64(),uri:e,name:n}),o.add(r),c.undoManager.transact(function(){c.$(i).on("load",function t(){c.$(i).off("load",t),c.nodeChanged(),s?c.editorUpload.uploadImagesAuto():(qt(f),Wt(c,f))}),d&&c.$(i).attr({width:d.w,height:d.h}),c.$(i).attr({src:r.blobUri()}).removeAttr("data-mce-src")}),r})},Nt=function(e,n,t,o){return function(){return e._scanForImages().then(E.curry(Pt,e)).then(it.blobToImageResult).then(t).then(function(t){return Vt(e,t,!1,n,o)},function(t){Lt(e,t)})}},$t={rotate:function(n,o,r){return function(){var t=It.getImageSize(Ht(n)),e=t?{w:t.h,h:t.w}:null;return Nt(n,o,function(t){return ot.rotate(t,r)},e)()}},flip:function(t,e,n){return function(){return Nt(t,e,function(t){return ot.flip(t,n)})()}},editImageDialog:function(e,o){return function(){var r=Ht(e),i=It.getNaturalImageSize(r),n=function(o){return new lt(function(n){N(o).then(function(t){var e=It.getNaturalImageSize(t);i.w===e.w&&i.h===e.h||It.getImageSize(r)&&It.setImageSize(r,e),ut.revokeObjectURL(t.src),n(o)})})};Pt(e).then(it.blobToImageResult).then(E.curry(function(e,t){return Rt.edit(e,t).then(n).then(it.blobToImageResult).then(function(t){return Vt(e,t,!0,o)},function(){})},e),function(t){Lt(e,t)})}},isEditableImage:function(t,e){return t.dom.is(e,"img:not([data-mce-object],[data-mce-placeholder])")&&(_t(t,e)||Ft(t,e)||t.settings.imagetools_proxy)},cancelTimedUpload:qt},Xt=function(n,t){Z.each({mceImageRotateLeft:$t.rotate(n,t,-90),mceImageRotateRight:$t.rotate(n,t,90),mceImageFlipVertical:$t.flip(n,t,"v"),mceImageFlipHorizontal:$t.flip(n,t,"h"),mceEditImage:$t.editImageDialog(n,t)},function(t,e){n.addCommand(e,t)})},Gt=function(n,o,r){n.on("NodeChange",function(t){var e=r.get();e&&e.src!==t.element.src&&($t.cancelTimedUpload(o),n.editorUpload.uploadImagesAuto(),r.set(null)),$t.isEditableImage(n,t.element)&&r.set(t.element)})},Yt=function(t){t.addButton("rotateleft",{title:"Rotate counterclockwise",cmd:"mceImageRotateLeft"}),t.addButton("rotateright",{title:"Rotate clockwise",cmd:"mceImageRotateRight"}),t.addButton("flipv",{title:"Flip vertically",cmd:"mceImageFlipVertical"}),t.addButton("fliph",{title:"Flip horizontally",cmd:"mceImageFlipHorizontal"}),t.addButton("editimage",{title:"Edit image",cmd:"mceEditImage"}),t.addButton("imageoptions",{title:"Image options",icon:"options",cmd:"mceImage"})},Jt=function(t){t.addContextToolbar(E.curry($t.isEditableImage,t),ft(t))};B.add("imagetools",function(t){var e=C(0),n=C(null);Xt(t,e),Yt(t),Jt(t),Gt(t,e,n)})}();
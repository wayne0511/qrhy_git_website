function cama_init_post(f){function i(){for(editor in tinymce.editors){editor=tinymce.editors[editor];$("#"+editor.id).val(tinymce.get(editor.id).getContent()).trigger("change")}return $form.serialize()}$form=$("#form-post"),"true"==f.recover_draft&&$form.css("opacity",0).before('<h2 style="text-align: center">'+I18n("msg.recover")+"</h2>");var c=".translate-item",p=f.post_id,u=f.post_draft_id,_=f.post_status,n=f._drafts_path,t=f._posts_path,m=f._ajax_path,s=f._post_tags_path;App_post.save_draft_ajax=function(a,t){!0;var e=$form.serializeObject();e._method=u?"patch":"post",e.post_id=p,$form.data("hash")==i()&&t||$.ajax({type:"POST",url:n,data:e,success:function(t){t.error?$.fn.alert({type:"error",title:t.error.join(", "),icon:"times"}):(t._drafts_path&&(n=t._drafts_path),u=t.draft.id,$("#post_draft_id").val(u)),a&&a(t)},dataType:"json",async:!1})},App_post.save_draft=function(){App_post.save_draft_ajax(function(){$form.data("submitted",1),location.href=t+"?flash[notice]="+I18n("msg.draft")})},window.post_editor_draft_intrval&&clearInterval(window.post_editor_draft_intrval),window.post_editor_draft_intrval=setInterval(function(){0==$form.length?clearInterval(window.post_editor_draft_intrval):App_post.save_draft_ajax(null,!0)},6e4),window.save_draft=App_post.save_draft_ajax,0==$form.find(".title-post"+c).length&&(c=""),$form.find(".title-post"+c).each(function(){function s(t){l.show().find(".sl-link").html(e.replace("__-__",'<span class="sl-url">'+t+"</span>")),l.find(".btn-preview").attr("href",e.replace("__-__",t)+"?draft_id="+u),d.trigger("change_in"),r()}function o(t){n&&n.abort(),n=$.ajax({type:"POST",url:m,data:{method:"exist_slug",slug:t,post_id:p},success:function(t){0<t.index&&(d.addClass("slugify-locked").val(t.slug),s(t.slug))}})}function r(){$("#meta_slug").val($form.find(".slug-post"+c).map(function(){return this.value}).get().join(","))}var t=$(this);if(!t.hasClass("sluged")){if(c)var a=t.attr("data-translation_l"),d=$form.find(".slug-post"+c+'[data-translation_l="'+a+'"]'),e=f._post_urls[a];else d=$form.find(".slug-post"),e=f._post_urls[Object.keys(f._post_urls)[0]];var l=$('<div class="sl-slug-edit"><strong>'+I18n("msg.permalink")+':&nbsp;</strong><span class="sl-link"></span> <span> &nbsp;&nbsp;</span><a href="#" class="btn btn-default btn-xs btn-edit">'+I18n("button.edit")+'</a> &nbsp;&nbsp; <a href="#" class="btn btn-info btn-xs btn-preview" target="_blank">'+I18n("msg.preview")+'</a> &nbsp;&nbsp; <a href="#" class="btn btn-success btn-xs btn-view" style="display: none" target="_blank">'+I18n("msg.view_page")+"</a></div>").hide();t.addClass("sluged"),t.after(l);var n=null,i=null;d.slugify(t,{change:function(t){""==t&&(t=Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,5)),s(i=t)}}),t.change(function(){i&&o(i)}),d.val()&&(s(d.val()),"published"==_&&l.find(".btn-view").show().attr("href",e.replace("__-__",d.val()))),l.find(".btn-preview").click(function(){var e=$(this);return showLoading(),App_post.save_draft_ajax(function(){hideLoading();var t=e.attr("href").split("draft_id=");t[1]=u;var a=e.clone().hide();a.insertAfter(e).attr("href",t.join("draft_id="))[0].click(),a.remove()}),!1}),l.find(".btn-edit").click(function(){function a(){n.show(),t.show(),i.remove(),e.remove()}var t=$(this),e=$('<a href="#" class="btn btn-default btn-xs btn-edit">'+I18n("button.accept")+'</a> &nbsp; <a href="#"  class="btn-cancel">'+I18n("button.cancel")+"</a>"),n=l.find(".sl-url"),i=$("<input type='text' />").keyup(function(t){if(13==t.keyCode)return e.filter(".btn-edit").click(),!1});return n.hide().after(i),t.hide().after(e),i.val(n.text()),e.filter(".btn-cancel").click(function(){return a(),r(),!1}),e.filter(".btn-edit").click(function(){var t=slugFunc(i.val());return t&&(d.addClass("slugify-locked").val(t),o(t),s(t),a()),!1}),!1})}});try{$(".tinymce_textarea:not(.translated-item)",$form).tinymce().destroy()}catch(a){}tinymce.init(cama_get_tinymce_settings({selector:".tinymce_textarea:not(.translated-item)",height:"480px",base_path:f.base_path})),$form.validate(),$("#post_status").change(function(){$("#post-actions .btn[data-type]").hide(),$('#post-actions .btn[data-type="'+$(this).val()+'"]').show()}),setTimeout(function(){var t=$("#form-post > #post_right_bar"),a=t.children(":first"),e=t.offset().top;$(window).scroll(function(){if($(window).width()<1024)return a.css({position:"",width:""}),void t.css("padding-top","");$(window).scrollTop()>=e+10?(a.css({position:"fixed",width:t.width()+"px",top:0,"z-index":4}),t.css("padding-top",a.height()+20)):(a.css({position:"",width:"auto"}),t.css("padding-top",""))}).resize(function(){1024<=$(window).width()&&t.show()}).scroll();var n=$.ajax({type:"GET",url:s,dataType:"json",async:!1}).responseText;$form.find(".tagsinput").tagEditor({autocomplete:{delay:0,position:{collision:"flip"},source:$.parseJSON(n)},forceLowercase:!1,placeholder:I18n("button.add_tag")+"..."}),$form.on("click",".gallery-item-remove",function(){return $("#feature-image").hide(),$("#feature-image input").val(""),!1}),$form.submit(function(){$(this).valid()&&$form.data("submitted",1)}),window.onbeforeunload=function(){if(!$form.data("submitted")&&0!=$("#form-post").length){if($form.data("hash")!=i())return"You sure to leave the page without saving changes?";if($form.data("submitted"))return"You sure to leave the page without saving changes?"}},$form.find("#post_add_new_category").ajax_modal({modal_size:"modal-lg",mode:"iframe",callback:function(t){t.find("iframe").on("load",function(){$(this).contents().find("#main-header, #sidebar-menu, #main-footer").hide(),$(this).contents().find("#admin_content").parent().css("margin-left",0)})},on_close:function(){var a=$form.find("#post_right_bar .list-categories");$.get($form.find("#post_add_new_category").data("reload-url"),{categories:a.find("input[name='categories[]']:checked").map(function(){return $(this).val()}).get()},function(t){a.html(t)})}})},1e3),setTimeout(function(){$form.data("hash",i())},2e3),"true"==f.recover_draft&&($form.data("validator").cancelSubmit=!0,$("#post_status").val("published"),$form.submit())}function cama_upload_feature_image(t){$.fn.upload_filemanager($.extend({formats:"image",selected:function(t){var a=t.url;$("#feature-image img").attr("src",a),$("#feature-image input").val(a),$("#feature-image .meta strong").html(t.name),$("#feature-image").show()}},t))}var App_post={},$form=null;
!function(p){p.fn.tagEditorInput=function(){var e=" ",i=p(this),a=parseInt(i.css("fontSize")),l=p("<span/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:i.css("fontSize"),fontFamily:i.css("fontFamily"),fontWeight:i.css("fontWeight"),letterSpacing:i.css("letterSpacing"),whiteSpace:"nowrap"}),t=function(){if(e!==(e=i.val())){l.html(e.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));var t=l.width()+a;t<20&&(t=20),t!=i.width()&&i.width(t)}};return l.insertAfter(i),i.bind("keyup keydown focus",t)},p.fn.tagEditor=function(a,l,r){function t(t){if(8==t.which||46==t.which||t.ctrlKey&&88==t.which){try{var e=getSelection(),a=p(e.getRangeAt(0).commonAncestorContainer)}catch(t){a=0}if(a&&a.hasClass("tag-editor")){var l=[],r=e.toString().split(a.prev().data("options").dregex);for(i=0;i<r.length;i++){var n=p.trim(r[i]);n&&l.push(n)}return p(".tag-editor-tag",a).each(function(){~p.inArray(p(this).html(),l)&&p(this).closest("li").find(".tag-editor-delete").click()}),!1}}}var h,u=p.extend({},p.fn.tagEditor.defaults,a),e=this;if(u.dregex=new RegExp("["+u.delimiter.replace("-","-")+"]","g"),"string"==typeof a){var n=[];return e.each(function(){var t=p(this),e=t.data("options"),i=t.next(".tag-editor");if("getTags"==a)n.push({field:t[0],editor:i,tags:i.data("tags")});else if("addTag"==a){if(e.maxTags&&i.data("tags").length>=e.maxTags)return!1;p('<li><div class="tag-editor-spacer">&nbsp;'+e.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i class="fa fa-times"></i></div></li>').appendTo(i).find(".tag-editor-tag").html('<input type="text" maxlength="'+e.maxLength+'">').addClass("active").find("input").val(l).blur(),r?p(".placeholder",i).remove():i.click()}else"removeTag"==a?(p(".tag-editor-tag",i).filter(function(){return p(this).html()==l}).closest("li").find(".tag-editor-delete").click(),r||i.click()):"destroy"==a&&t.removeClass("tag-editor-hidden-src").removeData("options").off("focus.tag-editor").next(".tag-editor").remove()}),"getTags"==a?n:this}return window.getSelection&&p(document).off("keydown.tag-editor").on("keydown.tag-editor",t),e.each(function(){function l(){!u.placeholder||c.length||p(".deleted, .placeholder, input",d).length||d.append('<li class="placeholder"><div>'+u.placeholder+"</div></li>")}function o(t){var e=c.toString();c=p(".tag-editor-tag:not(.deleted)",d).map(function(t,e){var i=p.trim(p(this).hasClass("active")?p(this).find("input").val():p(e).text());if(i)return i}).get(),d.data("tags",c),s.val(c.join(u.delimiter[0])),t||e!=c.toString()&&u.onChange(s,d,c),l()}function r(t){for(var e=t.closest("li"),i=t.val().replace(/ +/," ").split(u.dregex),a=t.data("old_tag"),l=c.slice(0),r=!1,n=0;n<i.length;n++)if((f=p.trim(i[n]).slice(0,u.maxLength))&&(u.forceLowercase&&(f=f.toLowerCase()),f=u.beforeTagSave(s,d,l,a,f)||f,u.removeDuplicates&&~p.inArray(f,l)&&p(".tag-editor-tag",d).each(function(){p(this).html()==f&&p(this).closest("li").remove()}),l.push(f),e.before('<li><div class="tag-editor-spacer">&nbsp;'+u.delimiter[0]+'</div><div class="tag-editor-tag">'+f+'</div><div class="tag-editor-delete"><i class="fa fa-times"></i></div></li>')),u.maxTags&&l.length>=u.maxTags){r=!0;break}t.attr("maxlength",u.maxLength).removeData("old_tag").val(""),r?t.blur():t.focus(),o()}var s=p(this),c=[],d=p("<ul "+(u.clickDelete?'oncontextmenu="return false;" ':"")+'class="tag-editor"></ul>').insertAfter(s);s.addClass("tag-editor-hidden-src").data("options",u).on("focus.tag-editor",function(){d.click()}),d.append('<li style="width:1px">&nbsp;</li>');var t,e,g='<li><div class="tag-editor-spacer">&nbsp;'+u.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i class="fa fa-times"></i></div></li>';d.click(function(l,r){var n,o,s=99999;if(!window.getSelection||""==getSelection())return u.maxTags&&d.data("tags").length>=u.maxTags?(d.find("input").blur(),!1):(h=!0,p("input:focus",d).blur(),h&&(h=!0,p(".placeholder",d).remove(),r&&r.length?o="before":p(".tag-editor-tag",d).each(function(){var t=p(this),e=t.offset(),i=e.left,a=e.top;l.pageY>=a&&l.pageY<=a+t.height()&&(l.pageX<i?(o="before",n=i-l.pageX):(o="after",n=l.pageX-i-t.width()),n<s&&(s=n,r=t))}),"before"==o?p(g).insertBefore(r.closest("li")).find(".tag-editor-tag").click():"after"==o?p(g).insertAfter(r.closest("li")).find(".tag-editor-tag").click():p(g).appendTo(d).find(".tag-editor-tag").click()),!1)}),d.on("click",".tag-editor-delete",function(){if(p(this).prev().hasClass("active"))return p(this).closest("li").find("input").caret(-1),!1;var t=p(this).closest("li"),e=t.find(".tag-editor-tag");return!1===u.beforeTagDelete(s,d,c,e.html())||(e.addClass("deleted").animate({width:0},u.animateDelete,function(){t.remove(),l()}),o()),!1}),u.clickDelete&&d.on("mousedown",".tag-editor-tag",function(t){if(t.ctrlKey||1<t.which){var e=p(this).closest("li"),i=e.find(".tag-editor-tag");return!1===u.beforeTagDelete(s,d,c,i.html())||(i.addClass("deleted").animate({width:0},u.animateDelete,function(){e.remove(),l()}),o()),!1}}),d.on("click",".tag-editor-tag",function(t){if(u.clickDelete&&(t.ctrlKey||1<t.which))return!1;if(!p(this).hasClass("active")){var e=p(this).html(),i=Math.abs((p(this).offset().left-t.pageX)/p(this).width()),a=parseInt(e.length*i),l=p(this).html('<input type="text" maxlength="'+u.maxLength+'" value="'+e+'">').addClass("active").find("input");if(l.data("old_tag",e).tagEditorInput().focus().caret(a),u.autocomplete){var r=p.extend({},u.autocomplete),n="select"in r?u.autocomplete.select:"";r.select=function(t,e){n&&n(t,e),setTimeout(function(){d.trigger("click",[p(".active",d).find("input").closest("li").next("li").find(".tag-editor-tag")])},20)},l.autocomplete(r)}}return!1}),d.on("blur","input",function(t){t.stopPropagation();var e=p(this),i=e.data("old_tag"),a=p.trim(e.val().replace(/ +/," ").replace(u.dregex,u.delimiter[0]));if(a){if(0<=a.indexOf(u.delimiter[0]))return void r(e);a!=i&&(u.forceLowercase&&(a=a.toLowerCase()),a=u.beforeTagSave(s,d,c,i,a)||a,u.removeDuplicates&&p(".tag-editor-tag:not(.active)",d).each(function(){p(this).html()==a&&p(this).closest("li").remove()}))}else{if(i&&!1===u.beforeTagDelete(s,d,c,i))return e.val(i).focus(),h=!1,void o();try{e.closest("li").remove()}catch(t){}i&&o()}e.parent().html(a).removeClass("active"),a!=i&&o(),l()}),d.on("paste","input",function(){p(this).removeAttr("maxlength"),t=p(this),setTimeout(function(){r(t)},30)}),d.on("keypress","input",function(t){0<=u.delimiter.indexOf(String.fromCharCode(t.which))&&(e=p(this),setTimeout(function(){r(e)},20))}),d.on("keydown","input",function(t){var e=p(this);if((37==t.which||!u.autocomplete&&38==t.which)&&!e.caret()||8==t.which&&!e.val())return(i=e.closest("li").prev("li").find(".tag-editor-tag")).length?i.click().find("input").caret(-1):!e.val()||u.maxTags&&d.data("tags").length>=u.maxTags||p(g).insertBefore(e.closest("li")).find(".tag-editor-tag").click(),!1;if((39==t.which||!u.autocomplete&&40==t.which)&&e.caret()==e.val().length)return(a=e.closest("li").next("li").find(".tag-editor-tag")).length?a.click().find("input").caret(0):e.val()&&d.click(),!1;if(9==t.which){if(t.shiftKey){var i;if((i=e.closest("li").prev("li").find(".tag-editor-tag")).length)i.click().find("input").caret(0);else{if(!e.val()||u.maxTags&&d.data("tags").length>=u.maxTags)return s.attr("disabled","disabled"),void setTimeout(function(){s.removeAttr("disabled")},30);p(g).insertBefore(e.closest("li")).find(".tag-editor-tag").click()}return!1}var a;if((a=e.closest("li").next("li").find(".tag-editor-tag")).length)a.click().find("input").caret(0);else{if(!e.val())return;d.click()}return!1}if(!(46!=t.which||p.trim(e.val())&&e.caret()!=e.val().length))return(a=e.closest("li").next("li").find(".tag-editor-tag")).length?a.click().find("input").caret(0):e.val()&&d.click(),!1;if(13==t.which)return d.trigger("click",[e.closest("li").next("li").find(".tag-editor-tag")]),!1;if(36!=t.which||e.caret()){if(35==t.which&&e.caret()==e.val().length)d.find(".tag-editor-tag").last().click();else if(27==t.which)return e.val(e.data("old_tag")?e.data("old_tag"):"").blur(),!1}else d.find(".tag-editor-tag").first().click()});for(var i=u.initialTags.length?u.initialTags:s.val().split(u.dregex),a=0;a<i.length&&!(u.maxTags&&a>=u.maxTags);a++){var f=p.trim(i[a].replace(/ +/," "));f&&(u.forceLowercase&&(f=f.toLowerCase()),c.push(f),d.append('<li><div class="tag-editor-spacer">&nbsp;'+u.delimiter[0]+'</div><div class="tag-editor-tag">'+f+'</div><div class="tag-editor-delete"><i class="fa fa-times"></i></div></li>'))}o(!0),u.sortable&&p.fn.sortable&&d.sortable({distance:5,cancel:".tag-editor-spacer, input",helper:"clone",update:function(){o()}})})},p.fn.tagEditor.defaults={initialTags:[],maxTags:0,maxLength:50,delimiter:",;",placeholder:"",forceLowercase:!0,removeDuplicates:!0,clickDelete:!1,animateDelete:175,sortable:!0,autocomplete:null,onChange:function(){},beforeTagSave:function(){},beforeTagDelete:function(){}}}(jQuery);